// Join for extensions, guest configuration, and SQL Server Arc
let arcServers = resources
| where type == "microsoft.hybridcompute/machines"
| extend 
    hasUpdateManager = isnotnull(properties.osProfile.windowsConfiguration.patchSettings.assessmentMode) or isnotnull(properties.osProfile.linuxConfiguration.patchSettings.assessmentMode),
    hasTags = isnotnull(tags) and tostring(tags) != "{}",
    isWS2025 = properties.osVersion contains "2025" or properties.osVersion contains "10.0.26100",
    hasHotpatch = tobool(properties.osProfile.windowsConfiguration.patchSettings.enableHotpatching),
    machineId = tolower(id)
| join kind=leftouter (
    resources
    | where type == "microsoft.hybridcompute/machines/extensions"
    | extend 
        machineId = tolower(substring(id, 0, indexof(id, "/extensions/"))),
        extType = tolower(tostring(properties.type)),
        extPublisher = tolower(tostring(properties.publisher)),
        extName = tolower(name)
    | summarize extensions = make_set(strcat(extType, "|", extPublisher, "|", extName)) by machineId
) on machineId
| join kind=leftouter (
    guestconfigurationresources
    | where type =~ 'microsoft.guestconfiguration/guestconfigurationassignments'
    | parse id with machineId '/providers/Microsoft.GuestConfiguration/guestConfigurationAssignments/' assignmentName
    | project machineId = tolower(machineId)
    | distinct machineId
    | extend hasGuestConfigAssignment = true
) on machineId
| extend 
    hasDefender = isnotnull(extensions) and (extensions has "mde" or extensions has "microsoft.azure.security"),
    hasInventory = isnotnull(extensions) and (extensions has "changetracking" or extensions has "microsoftmonitoringagent"),
    hasMonitoring = isnotnull(extensions) and (extensions has "azuremonitorwindowsagent" or extensions has "azuremonitorlinuxagent" or extensions has "loganalytics" or extensions has "omsagent"),
    hasGuestConfig = hasGuestConfigAssignment == true,
    hasBestPractice = isnotnull(extensions) and (extensions has "windowsserverassessment" or extensions has "assessmentplatform"),
    hasAdminCenter = isnotnull(extensions) and extensions has "admincenter"
| summarize 
    TotalServers = count(),
    UpdateManagerConfigured = countif(hasUpdateManager),
    TaggingConfigured = countif(hasTags),
    HotpatchConfigured = countif(isWS2025 and hasHotpatch),
    HotpatchTotal = countif(isWS2025),
    DefenderConfigured = countif(hasDefender),
    InventoryConfigured = countif(hasInventory),
    MonitoringConfigured = countif(hasMonitoring),
    GuestConfigConfigured = countif(hasGuestConfig),
    BestPracticeConfigured = countif(hasBestPractice),
    AdminCenterConfigured = countif(hasAdminCenter);
let sqlServers = resources
| where type == "microsoft.azurearcdata/sqlserverinstances"
| extend 
    machineId = tolower(tostring(properties.containerResourceId)),
    hasSqlBPA = tobool(properties.bestPracticesAssessment.assessmentStatus) == true or tostring(properties.bestPracticesAssessment.assessmentStatus) =~ "Enabled"
| join kind=leftouter (
    resources
    | where type == "microsoft.hybridcompute/machines/extensions"
    | where properties.type contains "AzureMonitorWindowsAgent" or properties.type contains "AzureMonitorLinuxAgent"
    | extend machineId = tolower(substring(id, 0, indexof(id, '/extensions/')))
    | summarize hasMonitoring = any(true) by machineId
) on machineId
| summarize 
    TotalSqlInstances = count(),
    SqlBpaConfigured = countif(hasSqlBPA),
    SqlPerfConfigured = countif(hasMonitoring == true);
arcServers
| extend 
    UpdateManagerUnconfigured = TotalServers - UpdateManagerConfigured,
    TaggingUnconfigured = TotalServers - TaggingConfigured,
    HotpatchUnconfigured = HotpatchTotal - HotpatchConfigured,
    DefenderUnconfigured = TotalServers - DefenderConfigured,
    InventoryUnconfigured = TotalServers - InventoryConfigured,
    MonitoringUnconfigured = TotalServers - MonitoringConfigured,
    GuestConfigUnconfigured = TotalServers - GuestConfigConfigured,
    BestPracticeUnconfigured = TotalServers - BestPracticeConfigured,
    AdminCenterUnconfigured = TotalServers - AdminCenterConfigured
| extend dummy = 1
| join kind=inner (sqlServers | extend dummy = 1) on dummy
| extend 
    SqlBpaUnconfigured = TotalSqlInstances - SqlBpaConfigured,
    SqlPerfUnconfigured = TotalSqlInstances - SqlPerfConfigured
| extend TotalSavings = todouble(
    (UpdateManagerUnconfigured * {UpdateManagerCost}) +
    (TaggingUnconfigured * {TaggingCost}) +
    (HotpatchUnconfigured * {HotpatchingCost}) +
    (DefenderUnconfigured * {DefenderCost}) +
    (InventoryUnconfigured * {InventoryCost}) +
    (MonitoringUnconfigured * {MonitoringCost}) +
    (GuestConfigUnconfigured * {GuestConfigCost}) +
    (BestPracticeUnconfigured * {BestPracticeCost}) +
    (AdminCenterUnconfigured * {AdminCenterCost}) +
    (SqlBpaUnconfigured * {SqlBpaCost}) +
    (SqlPerfUnconfigured * {SqlPerformanceCost}) +
    (TotalSqlInstances * {SqlInventoryCost}))
| project 
    TotalServers,
    TotalSqlInstances,
    TotalSavings,
    services = pack_array(
        pack("name", "Azure Arc-enabled Servers - Update Manager", "category", "Security & Compliance", "cost", {UpdateManagerCost}, "configured", UpdateManagerConfigured, "total", TotalServers),
        pack("name", "Arc-enabled Servers - Resource Tagging", "category", "Deployment & Management", "cost", {TaggingCost}, "configured", TaggingConfigured, "total", TotalServers),
        pack("name", "Arc-enabled Servers - Hotpatching (WS2025)", "category", "Security & Compliance", "cost", {HotpatchingCost}, "configured", HotpatchConfigured, "total", HotpatchTotal),
        pack("name", "Arc-enabled Servers - Microsoft Defender for Cloud", "category", "Security & Compliance", "cost", {DefenderCost}, "configured", DefenderConfigured, "total", TotalServers),
        pack("name", "Azure Arc-enabled Servers - Inventory & Tracking", "category", "Security & Compliance", "cost", {InventoryCost}, "configured", InventoryConfigured, "total", TotalServers),
        pack("name", "Arc-enabled Servers - Monitoring & Insights", "category", "Deployment & Management", "cost", {MonitoringCost}, "configured", MonitoringConfigured, "total", TotalServers),
        pack("name", "Azure Arc-enabled Servers - Guest Configuration", "category", "Security & Compliance", "cost", {GuestConfigCost}, "configured", GuestConfigConfigured, "total", TotalServers),
        pack("name", "Arc-enabled Servers - Best Practice Assessment", "category", "Security & Compliance", "cost", {BestPracticeCost}, "configured", BestPracticeConfigured, "total", TotalServers),
        pack("name", "Arc-enabled Servers - Windows Admin Center", "category", "Deployment & Management", "cost", {AdminCenterCost}, "configured", AdminCenterConfigured, "total", TotalServers),
        pack("name", "SQL Server Arc - Best Practices Assessment", "category", "SQL Server Arc", "cost", {SqlBpaCost}, "configured", SqlBpaConfigured, "total", TotalSqlInstances),
        pack("name", "SQL Server Arc - Performance Monitoring", "category", "SQL Server Arc", "cost", {SqlPerformanceCost}, "configured", SqlPerfConfigured, "total", TotalSqlInstances),
        pack("name", "SQL Server Arc - Inventory & Configuration", "category", "SQL Server Arc", "cost", {SqlInventoryCost}, "configured", TotalSqlInstances, "total", TotalSqlInstances),
        pack("name", "ðŸ’° TOTAL ESTIMATED LABOR SAVINGS", "category", "Totals", "cost", 0, "configured", 0, "total", 0)
    )
| mv-expand service = services
| extend 
    ServiceName = tostring(service.name),
    Category = tostring(service.category),
    Cost = toint(service.cost),
    Configured = tolong(service.configured),
    Total = tolong(service.total)
| extend 
    Unconfigured = Total - Configured,
    Percent = iff(Total > 0, round(todouble(Configured) * 100.0 / todouble(Total), 1), 0.0)
| extend Savings = iff(ServiceName startswith "ðŸ’°", TotalSavings, todouble(Unconfigured * Cost))
| extend Status = iff(ServiceName startswith "ðŸ’°", "", case(Percent >= 100.0, "ðŸŸ¢ Fully Configured", Percent > 0.0, "ðŸŸ¡ Partially Configured", "ðŸ”´ Not Configured"))
| extend SortOrder = iff(ServiceName startswith "ðŸ’°", 1, 0)
| project ServiceName, Category, ConfiguredServers = iff(ServiceName startswith "ðŸ’°", tolong(-1), Configured), UnconfiguredServers = iff(ServiceName startswith "ðŸ’°", tolong(-1), Unconfigured), PercentConfigured = iff(ServiceName startswith "ðŸ’°", todouble(-1), Percent), PotentialSavings = Savings, Status, SortOrder
| order by SortOrder asc, PotentialSavings desc
| project-away SortOrder
